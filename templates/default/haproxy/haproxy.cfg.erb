# This file was generated by chef-alfresco

# General Configurations: global, timeouts
<% node['haproxy']['general_config'].each do |line| -%>
<%= line %>
<% end -%>
# Log format
<%= node['haproxy']['logformat'] %>

# Frontends

<% if node['haproxy']['frontends'] -%>
  <% node['haproxy']['frontends'].each do |frontendName,frontend| -%>
# START frontend <%= frontendName %>
frontend <%= frontendName %>
    <% if frontend['entries'] -%>
      <% frontend['entries'].each do |entry| -%>
<%= entry %>
      <% end -%>
    <% end -%>
    <% if frontend['headers'] -%>
      <% frontend['headers'].each do |header| -%>
<%= header %>
      <% end -%>
    <% end -%>
# Backend ACLs
    <% if frontend['acls'] -%>
      <% frontend['acls'].each do |backendName,acls| -%>
        <% if acls -%>
          <% acls.each do |acl| -%>
acl is_<%= backendName %> <%= acl %>
          <% end -%>
        <% end -%>
      <% end -%>
    <% end -%>
# Free formed ACLs
    <% if frontend['acl_lines'] -%>
      <% frontend['acl_lines'].each do |acl| -%>
acl <%= acl %>
      <% end -%>
    <% end -%>
# Other Configurations
    <% if frontend['other_config'] -%>
      <% frontend['other_config'].each do |other_config| -%>
<%= other_config %>
      <% end -%>
    <% end -%>
# Redirects
    <% if frontend['redirects'] -%>
      <% frontend['redirects'].each do |redirect| -%>
<%= redirect %>
      <% end -%>
    <% end -%>
# Use backends
    <% if frontend['acls'] -%>
      <% frontend['acls'].each do |backendName,acls| -%>
use_backend <%= backendName %> if is_<%= backendName %>
      <% end -%>
    <% end -%>
# Default Backend
default_backend <%= node['haproxy']['default_backend'] %>
# END frontend <%= frontendName %>

  <% end -%>
<% end -%>

# Backends

<% if @haproxy_backends -%>
  <% @haproxy_backends.each do |backendName,backend| -%>
# START <%= backendName %> backend
backend <%= backendName %>
    <% if backend['entries'] -%>
      <% backend['entries'].each do |entry| -%>
<%= entry %>
      <% end -%>
    <% end -%>
    <% if backend['secure_entries'] -%>
      <% backend['secure_entries'].each do |secure_entry| -%>
<%= secure_entry %>
      <% end -%>
    <% end -%>
    <% if backend['enabled_local'] -%>
server local_<%= backendName %> 127.0.0.1:<%= backend['port'] %> check inter 5000
    <% end -%>
    <% if backend['zones'] -%>
      <% backend['zones'].each do |zoneName,zoneParams| -%>
        <% if zoneParams['current'] == true -%>
          <% zoneParams['nodes'].each do |nodeHost,nodeIp| -%>
server <%= nodeHost %> <%= nodeIp %>:<%= backend['port'] %> check inter 5000
          <% end -%>
        <% end -%>
      <% end -%>
      <% backend['zones'].each do |zoneName,zoneParams| -%>
        <% unless zoneParams['current'] == true -%>
          <% zoneParams['nodes'].each do |nodeHost,nodeIp| -%>
server <%= nodeHost %> <%= nodeIp %>:<%= backend['port'] %> check inter 5000
          <% end -%>
        <% end -%>
      <% end -%>
    <% end -%>
    # END <%= backendName %> backend

  <% end -%>
<% end -%>
